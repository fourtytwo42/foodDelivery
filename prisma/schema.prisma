// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION (Stage 1)
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  phone         String?
  avatar        String?
  emailVerified Boolean   @default(false)
  emailVerificationToken String? @unique
  passwordResetToken String? @unique
  passwordResetExpires DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  lastLoginAt   DateTime?
  
  roles         UserRole[]
  addresses     Address[]  @relation("UserAddresses")
  orders        Order[]    @relation("OrderUser")
  createdOrders Order[]    @relation("OrderCreator")
  paymentMethods SavedPaymentMethod[] @relation("UserPaymentMethods")
  deliveries    Delivery[] @relation("DriverDeliveries")
  purchasedGiftCards GiftCard[] @relation("GiftCardPurchaser")
  createdCoupons Coupon[] @relation("CouponCreator")
  couponUsages  CouponUsage[] @relation("CouponUsageUser")
  loyaltyAccount LoyaltyAccount?
  
  @@index([email])
  @@index([createdAt])
  @@index([deletedAt])
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       UserRole[]
  
  @@index([name])
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

// ============================================
// RESTAURANT SETTINGS (Stage 1)
// ============================================

model RestaurantSettings {
  id                    String   @id @default("default")
  
  name                  String
  description           String?  @db.Text
  phone                 String?
  email                 String?
  website               String?
  logo                  String?
  banner                String?
  
  address               String
  city                  String
  state                 String
  zipCode               String
  country               String   @default("US")
  latitude              Float?
  longitude             Float?
  
  hoursMonday           Json?
  hoursTuesday          Json?
  hoursWednesday        Json?
  hoursThursday         Json?
  hoursFriday           Json?
  hoursSaturday         Json?
  hoursSunday           Json?
  specialHours          Json?
  
  minOrderAmount        Decimal? @db.Decimal(10, 2)
  maxDeliveryDistance   Float?
  defaultPrepTime       Int?
  autoAcceptOrders      Boolean  @default(false)
  taxRate               Decimal  @default(0.0) @db.Decimal(5, 4)
  
  enableLoyaltyPoints   Boolean  @default(false)
  loyaltyPointsPerDollar Decimal? @default(0.5) @db.Decimal(5, 2)
  loyaltyPointsForFree  Int?     @default(100)
  enableEmailNotifications Boolean @default(true)
  enableSMSNotifications  Boolean @default(false)
  enableEmailVerification  Boolean @default(false)
  enableReCAPTCHA       Boolean @default(false)
  reCAPTCHASiteKey      String?
  reCAPTCHASecretKey    String?
  
  demoMode              Boolean  @default(true)
  setupWizardEnabled    Boolean  @default(false)
  
  primaryColor          String?  @default("#FF6B35")
  secondaryColor        String?  @default("#004E89")
  menuDisplayStyle      String   @default("grid")
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdBy             String?
  updatedBy             String?
  
  @@index([zipCode])
}

// ============================================
// MENU (Stage 2)
// ============================================

model MenuCategory {
  id              String   @id @default(cuid())
  name            String
  description     String?  @db.Text
  image           String?
  order           Int      @default(0)
  active          Boolean  @default(true)
  availableTimes Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  createdBy       String?
  updatedBy       String?
  
  items           MenuItem[]
  
  @@index([order])
  @@index([active])
  @@index([deletedAt])
}

model MenuItem {
  id                String   @id @default(cuid())
  categoryId        String
  name              String
  description       String?  @db.Text
  image             String?
  price             Decimal  @db.Decimal(10, 2)
  active            Boolean  @default(true)
  featured          Boolean  @default(false)
  popular           Boolean  @default(false)
  availableTimes    Json?
  dietaryTags       String[]
  allergens         String[]
  calories          Int?
  nutritionInfo     Json?
  preparationTime   Int?
  spiceLevel        Int?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?
  createdBy         String?
  updatedBy         String?
  
  category          MenuCategory @relation(fields: [categoryId], references: [id])
  modifiers         MenuItemModifier[]
  orderItems        OrderItem[]
  
  @@index([categoryId])
  @@index([active])
  @@index([featured])
  @@index([popular])
  @@index([deletedAt])
}

model Modifier {
  id              String   @id @default(cuid())
  name            String
  description     String?  @db.Text
  type            String
  required        Boolean  @default(false)
  minSelections   Int?
  maxSelections   Int?
  active          Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  createdBy       String?
  updatedBy       String?
  
  options         ModifierOption[]
  itemModifiers   MenuItemModifier[]
  
  @@index([active])
  @@index([deletedAt])
}

model ModifierOption {
  id              String   @id @default(cuid())
  modifierId      String
  name            String
  description     String?  @db.Text
  price           Decimal  @default(0.0) @db.Decimal(10, 2)
  priceType       String   @default("FIXED")
  active          Boolean  @default(true)
  order           Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?
  createdBy       String?
  updatedBy       String?
  
  modifier        Modifier @relation(fields: [modifierId], references: [id], onDelete: Cascade)
  orderModifiers  OrderModifier[]
  
  @@index([modifierId])
  @@index([active])
  @@index([order])
  @@index([deletedAt])
}

model MenuItemModifier {
  id              String   @id @default(cuid())
  menuItemId      String
  modifierId      String
  required        Boolean  @default(false)
  order           Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  menuItem        MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifier        Modifier @relation(fields: [modifierId], references: [id], onDelete: Cascade)
  
  @@unique([menuItemId, modifierId])
  @@index([menuItemId])
  @@index([modifierId])
}

// ============================================
// ORDERS (Stage 3)
// ============================================

model Order {
  id                  String   @id @default(cuid())
  orderNumber         String   @unique
  userId              String?
  customerEmail       String?
  customerPhone       String?
  customerName        String?
  type                String   // "DELIVERY" | "PICKUP"
  status              String   @default("PENDING")
  subtotal            Decimal  @db.Decimal(10, 2)
  tax                 Decimal  @db.Decimal(10, 2)
  deliveryFee         Decimal  @default(0.0) @db.Decimal(10, 2)
  tip                 Decimal  @default(0.0) @db.Decimal(10, 2)
  discount            Decimal  @default(0.0) @db.Decimal(10, 2)
  total               Decimal  @db.Decimal(10, 2)
  deliveryAddressId   String?
  deliveryAddress     Json?
  estimatedDeliveryTime DateTime?
  actualDeliveryTime  DateTime?
  paymentStatus       String   @default("PENDING")
  paymentMethod       String?
  paymentIntentId     String?
  specialInstructions String?  @db.Text
  deliveryInstructions String? @db.Text
  placedAt            DateTime @default(now())
  confirmedAt         DateTime?
  preparingAt         DateTime?
  readyAt             DateTime?
  outForDeliveryAt    DateTime?
  deliveredAt         DateTime?
  cancelledAt         DateTime?
  cancelledBy         String?
  cancellationReason  String?  @db.Text
  createdBy           String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  user                User?    @relation("OrderUser", fields: [userId], references: [id])
  creator             User?    @relation("OrderCreator", fields: [createdBy], references: [id])
  items               OrderItem[]
  payments            Payment[]
  delivery            Delivery?
  couponUsages        CouponUsage[]
  giftCardTransactions GiftCardTransaction[]
  loyaltyTransactions  LoyaltyTransaction[]
  
  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([type])
  @@index([paymentStatus])
  @@index([placedAt])
}

model OrderItem {
  id              String   @id @default(cuid())
  orderId         String
  menuItemId      String
  name            String
  description     String?  @db.Text
  price           Decimal  @db.Decimal(10, 2)
  quantity        Int      @default(1)
  specialInstructions String? @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItem        MenuItem @relation(fields: [menuItemId], references: [id])
  modifiers       OrderModifier[]
  
  @@index([orderId])
  @@index([menuItemId])
}

model OrderModifier {
  id                  String   @id @default(cuid())
  orderItemId         String
  modifierOptionId    String
  modifierName        String
  optionName          String
  price               Decimal  @db.Decimal(10, 2)
  quantity            Int      @default(1)
  
  createdAt           DateTime @default(now())
  
  orderItem           OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifierOption      ModifierOption @relation(fields: [modifierOptionId], references: [id])
  
  @@index([orderItemId])
  @@index([modifierOptionId])
}

// ============================================
// PAYMENTS (Stage 4)
// ============================================

model Payment {
  id                  String   @id @default(cuid())
  orderId             String
  amount              Decimal  @db.Decimal(10, 2)
  currency            String   @default("USD")
  status              String   @default("PENDING")
  // "PENDING" | "PROCESSING" | "COMPLETED" | "FAILED" | "REFUNDED" | "CANCELLED"
  paymentMethod       String
  // "STRIPE" | "PAYPAL" | "APPLE_PAY" | "GOOGLE_PAY" | "GIFT_CARD" | "CASH"
  paymentMethodId     String?  // Stripe payment method ID, PayPal transaction ID, etc.
  transactionId       String?  // External transaction ID
  paymentIntentId     String?  // Stripe payment intent ID
  refundId            String?  // Refund transaction ID
  failureReason       String?  @db.Text
  metadata            Json?
  processedAt         DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@index([orderId])
  @@index([status])
  @@index([paymentMethod])
  @@index([transactionId])
  @@index([paymentIntentId])
}

model SavedPaymentMethod {
  id                  String   @id @default(cuid())
  userId              String
  type                String   // "STRIPE" | "PAYPAL"
  providerId          String   // Stripe customer ID, PayPal payer ID, etc.
  paymentMethodId     String   // Stripe payment method ID, PayPal billing agreement ID
  label               String?  // "Visa ending in 1234", "PayPal Account"
  last4               String?  // Last 4 digits of card
  brand               String?  // "visa", "mastercard", "paypal"
  expiryMonth         Int?
  expiryYear          Int?
  isDefault           Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  user                User     @relation("UserPaymentMethods", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isDefault])
}

// ============================================
// DELIVERIES (Stage 6)
// ============================================

model Delivery {
  id                  String   @id @default(cuid())
  orderId             String   @unique
  driverId            String?
  status              String   @default("PENDING")
  // "PENDING" | "ASSIGNED" | "ACCEPTED" | "PICKED_UP" | "IN_TRANSIT" | "DELIVERED" | "FAILED"
  
  // Address
  deliveryAddress     Json     // Full address JSON
  latitude            Float?
  longitude           Float?
  
  // Driver Location (for tracking)
  driverLatitude      Float?
  driverLongitude     Float?
  driverLocationUpdatedAt DateTime?
  
  // Estimated times
  estimatedPickupTime DateTime?
  estimatedDeliveryTime DateTime?
  actualPickupTime    DateTime?
  actualDeliveryTime  DateTime?
  
  // Distance
  distance            Float?   // Miles
  routeOptimized      Boolean  @default(false)
  
  // Notes
  deliveryNotes       String?  @db.Text
  driverNotes         String?  @db.Text
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  driver              User?    @relation("DriverDeliveries", fields: [driverId], references: [id])
  
  @@index([orderId])
  @@index([driverId])
  @@index([status])
  @@index([estimatedDeliveryTime])
}

// ============================================
// GIFT CARDS (Stage 7)
// ============================================

model GiftCard {
  id                  String   @id @default(cuid())
  code                String   @unique
  pin                 String?  // Optional PIN for additional security
  originalBalance     Decimal  @db.Decimal(10, 2)
  currentBalance      Decimal  @db.Decimal(10, 2)
  currency            String   @default("USD")
  status              String   @default("ACTIVE") // "ACTIVE" | "USED" | "EXPIRED" | "CANCELLED"
  purchasedBy         String?  // User ID who purchased
  purchasedAt         DateTime?
  expiresAt           DateTime?
  lastUsedAt          DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  purchaser           User?    @relation("GiftCardPurchaser", fields: [purchasedBy], references: [id])
  transactions        GiftCardTransaction[]
  
  @@index([code])
  @@index([status])
  @@index([purchasedBy])
}

model GiftCardTransaction {
  id                  String   @id @default(cuid())
  giftCardId          String
  orderId             String?
  amount              Decimal  @db.Decimal(10, 2) // Positive for usage, negative for refund
  type                String   // "PURCHASE" | "USAGE" | "REFUND" | "EXPIRATION"
  description         String?  @db.Text
  createdAt           DateTime @default(now())
  
  giftCard            GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)
  order               Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  @@index([giftCardId])
  @@index([orderId])
}

// ============================================
// COUPONS (Stage 7)
// ============================================

model Coupon {
  id                  String   @id @default(cuid())
  code                String   @unique
  name                String
  description         String?  @db.Text
  type                String   // "PERCENTAGE" | "FIXED" | "BUY_X_GET_Y" | "FREE_SHIPPING"
  discountValue       Decimal? @db.Decimal(10, 2) // Percentage or fixed amount
  minOrderAmount      Decimal? @db.Decimal(10, 2)
  maxDiscountAmount   Decimal? @db.Decimal(10, 2)
  buyXGetY            Json?    // { buyQuantity: 2, getQuantity: 1, getItemId: "item123" }
  status              String   @default("ACTIVE") // "ACTIVE" | "INACTIVE" | "EXPIRED"
  usageLimit          Int?     // Total usage limit
  usageCount          Int      @default(0)
  usageLimitPerUser   Int?     // Usage limit per user
  validFrom           DateTime
  validUntil          DateTime
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  createdBy           String?
  
  creator             User?    @relation("CouponCreator", fields: [createdBy], references: [id])
  usages              CouponUsage[]
  
  @@index([code])
  @@index([status])
  @@index([validFrom])
  @@index([validUntil])
}

model CouponUsage {
  id                  String   @id @default(cuid())
  couponId            String
  orderId             String
  userId              String?
  discountAmount      Decimal  @db.Decimal(10, 2)
  usedAt              DateTime @default(now())
  
  coupon              Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user                User?    @relation("CouponUsageUser", fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([couponId])
  @@index([orderId])
  @@index([userId])
}

// ============================================
// LOYALTY POINTS (Stage 7)
// ============================================

model LoyaltyAccount {
  id                  String   @id @default(cuid())
  userId              String   @unique
  points              Int      @default(0)
  lifetimePoints      Int      @default(0) // Total points ever earned
  tier                String   @default("BRONZE") // "BRONZE" | "SILVER" | "GOLD" | "PLATINUM"
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions        LoyaltyTransaction[]
  
  @@index([userId])
  @@index([points])
}

model LoyaltyTransaction {
  id                  String   @id @default(cuid())
  loyaltyAccountId    String
  orderId             String?
  points              Int      // Positive for earning, negative for redemption
  type                String   // "EARNED" | "REDEEMED" | "EXPIRED" | "ADJUSTED"
  description         String?  @db.Text
  createdAt           DateTime @default(now())
  
  loyaltyAccount      LoyaltyAccount @relation(fields: [loyaltyAccountId], references: [id], onDelete: Cascade)
  order               Order?         @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  @@index([loyaltyAccountId])
  @@index([orderId])
}

// ============================================
// ADDRESSES (Stage 3)
// ============================================

model Address {
  id              String   @id @default(cuid())
  userId          String
  label           String?  // "Home", "Work", etc.
  firstName       String?
  lastName        String?
  street          String
  city            String
  state           String
  zipCode         String
  country         String   @default("US")
  phone           String?
  isDefault       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation("UserAddresses", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

